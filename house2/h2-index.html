<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cake Factory - House 2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        image-rendering: pixelated; /* Apply pixelation to all images */
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
    }

    body {
        font-family: "VT323", monospace;
        font-weight: 400;
        color: #ffffff;
        overflow: hidden;
        height: 100vh;
        width: 100vw;
        position: relative;
        /* Heavy pixelated background - solid color as per image */
        background: linear-gradient(180deg, #ff9999 0%, #ff9999 33%, #ffb3b3 33%, #ffb3b3 66%, #ff8080 66%, #ff8080 100%);
        image-rendering: pixelated; /* Ensure body also gets pixelation for overall effect */
    }

    /* Kitchen Background Recreation */
    .kitchen-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
    }

    /* Top Wall */
    .top-wall {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 35%;
        /* Heavy pixelated background - solid color as per image */
        background: linear-gradient(180deg, #ff9999 0%, #ff9999 50%, #ffb3b3 50%, #ffb3b3 100%);
        border-bottom: 3px solid #666;
        box-shadow: 0 2px 0 #333; /* Pixelated shadow for borders */
    }

    /* Conveyor Belt */
    .conveyor-belt {
        position: absolute;
        top: 35%;
        left: 0;
        width: 100%;
        height: 25%;
        /* Heavy pixelated background - solid color as per image */
        background: linear-gradient(180deg, #888 0%, #888 33%, #666 33%, #666 66%, #444 66%, #444 100%);
        border-top: 2px solid #aaa;
        border-bottom: 2px solid #222;
        box-shadow: 0 2px 0 #333; /* Pixelated shadow for borders */
    }

    .conveyor-track {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 4px;
        background: repeating-linear-gradient(90deg, #333 0px, #333 20px, #555 20px, #555 40px);
        transform: translateY(-50%);
        box-shadow: 0 1px 0 #000; /* Pixelated shadow */
    }

    /* Bottom Control Area */
    .control-area {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 40%; /* Reverted to 40% to match original layout */
        /* Heavy pixelated background - solid color as per image */
        background: linear-gradient(180deg, #f3cff3 0%, #f8b9f8 30%, #f6a1f6  60%, #f6e4f6  84%, #ffffff  100%);
        border-top: 3px solid #999;
        box-shadow: 0 -2px 0 #666; /* Pixelated shadow for borders */
    }

    /* Checkered Floor - Shifted below ingredient grid */
    .checkered-floor {
        position: absolute;
        bottom: 0; /* Position at the very bottom of the control area */
        left: 0;
        width: 100%;
        height: 10%; /* Increased height to be visible behind grid */
        background-image: 
            linear-gradient(45deg, #000 25%, transparent 25%), 
            linear-gradient(-45deg, #000 25%, transparent 25%), 
            linear-gradient(45deg, transparent 75%, #000 75%), 
            linear-gradient(-45deg, transparent 75%, #000 75%);
        background-size: 30px 30px;
        background-position: 0 0, 0 15px, 15px -15px, -15px 0px;
        box-shadow: inset 0 2px 0 #333; /* Pixelated shadow */
    }

    .back-btn {
        position: absolute;
        top: 15px;
        left: 15px;
        background: linear-gradient(145deg, #da70d6, #ba55d3);
        border: 2px solid #ff69b4;
        border-radius: 6px;
        color: #ffffff;
        font-family: 'VT323', monospace;
        font-size: 12px;
        font-weight: 400;
        padding: 5px 10px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        box-shadow: 0 2px 0 #8b008b;
        z-index: 1000;
        text-shadow: 1px 1px 0 #000; /* Pixelated text shadow */
    }

    .back-btn:hover {
        background: linear-gradient(145deg, #ba55d3, #da70d6);
        transform: translateY(-1px);
        box-shadow: 0 3px 0 #8b008b;
    }

    /* Game Stats Panel */
    .stats-panel {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid #00ffff;
        border-radius: 6px;
        padding: 8px;
        color: #ffffff;
        font-size: 12px;
        z-index: 1000;
        min-width: 120px;
        box-shadow: 0 2px 0 #008080; /* Pixelated shadow */
    }

    .stat-item {
        margin-bottom: 3px;
        display: flex;
        justify-content: space-between;
        text-shadow: 1px 1px 0 #000; /* Pixelated text shadow */
    }

    /* Order Display - Left Monitor */
    .order-display {
        position: absolute;
        top: 8%;
        left: 2%;
        width: 12%;
        height: 20%;
        background: linear-gradient(145deg, #e6e6ff, #ccccff);
        border: 3px solid #4444aa;
        border-radius: 8px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .order-title {
        color: #000080;
        font-size: 15px;
        margin-bottom: 5px;
        text-align: center;
        font-weight: bold;
        text-shadow: 1px 1px 0 #fff; /* Pixelated text shadow */
    }

    .order-stack {
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        justify-content: flex-end;
        gap: 0;
        position: relative;
        padding-bottom: 10px;
    }

    .order-item {
        width: 100px; /* Further increased size */
        height: 60px; /* Further increased size */
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        position: relative;
        margin-top: -25px; /* Adjusted negative margin for more overlap */
    }
    .order-item:first-child {
        margin-top: 0; /* No negative margin for the very first item (bottom) */
    }
    /* Specific adjustment for topping in order display */
    .order-item.topping-layer {
        margin-top: -4px; /* Less negative margin for topping to sit higher */
    }


    /* Conveyor Work Stations */
    .conveyor-stations {
        position: absolute;
        top: 37%;
        left: 15%;
        width: 70%;
        height: 20%; /* Slightly increased height to accommodate larger desserts */
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .work-station {
        width: 18%;
        height: 90%; /* Ensure work station uses full height of conveyor-stations */
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        position: relative;
        padding: 5px;
    }

    .work-station.active {
        border-color: #ff69b4;
        background: rgba(255, 105, 180, 0.2);
        box-shadow: 0 0 10px rgba(255, 105, 180, 0.5);
    }

    .dessert-stack {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        height: 100%;
        gap: 0;
        position: relative;
    }

    .dessert-layer {
        width: 90px; /* Further increased size */
        height: 70px; /* Further increased size */
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        position: relative;
        z-index: 1;
        margin-top: -30px; /* Adjusted negative margin for more overlap */
    }
    .dessert-layer:first-child {
        margin-top: 0; /* No negative margin for the very first item (bottom) */
    }
    /* Specific adjustment for topping on conveyor */
    .dessert-layer.topping-layer {
        margin-top: -10px; /* Less negative margin for topping to sit higher */
    }

    /* Ingredient Selection Grid */
    .ingredient-grid {
        position: absolute;
        bottom: 25%; /* Adjusted to sit correctly above the checkered floor */
        left: 15%;
        width: 70%;
        height: 15%;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 8px;
        z-index: 1000;
    }

    .ingredient-btn {
        background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
        border: 3px solid #999;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .ingredient-btn img {
        width: 70px; /* Increased size for better visibility */
        height: 70px; /* Increased size for better visibility */
        object-fit: contain;
    }
    /* Specific size for cherry image */
    .ingredient-btn img[alt="Cherry"] {
        width: 40px; /* Smaller cherry */
        height: 40px; /* Smaller cherry */
    }

    .ingredient-btn:hover {
        background: linear-gradient(145deg, #ffffff, #f0f0f0);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .ingredient-btn.selected {
        background: linear-gradient(145deg, #ffb3ff, #ff99ff);
        border-color: #ff69b4;
        box-shadow: 0 0 10px rgba(255, 105, 180, 0.8);
    }

    /* Control Buttons */
    .control-buttons {
        position: absolute;
        bottom: 5%;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 1000;
    }

    .control-btn {
        background: linear-gradient(145deg, #da70d6, #ba55d3);
        border: 2px solid #ff69b4;
        border-radius: 6px;
        color: #ffffff;
        font-family: 'VT323', monospace;
        font-size: 14px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 3px 0 #8b008b;
        text-shadow: 1px 1px 0 #000; /* Pixelated text shadow */
    }

    .control-btn:hover {
        background: linear-gradient(145deg, #ba55d3, #da70d6);
        transform: translateY(-2px);
        box-shadow: 0 5px 0 #8b008b;
    }

    .control-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 0 #8b008b;
    }

    .control-btn:disabled {
        background: #666;
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* Game Over Modal */
    .game-over {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(145deg, #4a2c5a, #3a1e4a);
        border: 4px solid #ba55d3;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 0 25px rgba(186, 85, 211, 0.6);
        z-index: 2000;
        display: none;
    }

    .game-over h2 {
        color: #da70d6;
        font-size: 20px;
        margin-bottom: 12px;
        text-shadow: 2px 2px 0 #000; /* Pixelated text shadow */
    }

    .game-over p {
        font-size: 14px;
        margin-bottom: 6px;
        text-shadow: 1px 1px 0 #000; /* Pixelated text shadow */
    }

    /* Feedback Messages */
    .feedback {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        color: #ffffff;
        padding: 12px 25px;
        border-radius: 6px;
        font-size: 16px;
        z-index: 1500;
        display: none;
        text-align: center;
        text-shadow: 1px 1px 0 #000; /* Pixelated text shadow */
    }

    .feedback.success {
        border: 3px solid #00ff00;
        color: #00ff00;
    }

    .feedback.error {
        border: 3px solid #ff0000;
        color: #ff0000;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .ingredient-grid {
            bottom: 20%;
            left: 10%;
            width: 80%;
            height: 18%;
            gap: 5px;
        }
        
        .ingredient-btn img {
            width: 60px; /* Adjusted for smaller screens */
            height: 60px; /* Adjusted for smaller screens */
        }
        .ingredient-btn img[alt="Cherry"] {
            width: 40px; /* Smaller cherry for smaller screens */
            height: 40px; /* Smaller cherry for smaller screens */
        }
        
        .conveyor-stations {
            left: 10%;
            width: 80%;
            height: 25%; /* Adjusted for smaller screens */
        }
        
        .order-display {
            width: 20%; /* Increased width for better visibility */
            height: 28%; /* Increased height for better visibility */
        }
        
        .dessert-layer {
            width: 70px; /* Adjusted for smaller screens */
            height: 55px; /* Adjusted for smaller screens */
            margin-top: -20px; /* Adjusted for smaller screens */
        }
        .dessert-layer.topping-layer {
            margin-top: -10px; /* Adjusted for smaller screens */
        }
        
        .order-item {
            width: 60px; /* Adjusted for smaller screens */
            height: 45px; /* Adjusted for smaller screens */
            margin-top: -20px; /* Adjusted for smaller screens */
        }
        .order-item.topping-layer {
            margin-top: -8px; /* Adjusted for smaller screens */
        }
    }
</style>
</head>
<body>
    <!-- Kitchen Background -->
    <div class="kitchen-bg">
        <div class="top-wall"></div>
        <div class="conveyor-belt">
            <div class="conveyor-track"></div>
        </div>
        <div class="control-area"></div>
        <div class="checkered-floor"></div>
    </div>

    <a href="index.html" class="back-btn">← Home</a>

    <!-- Game Stats -->
    <div class="stats-panel">
        <div class="stat-item">
            <span>Score:</span>
            <span id="score">0</span>
        </div>
        <div class="stat-item">
            <span>Orders:</span>
            <span id="orders-completed">0</span>
        </div>
        <div class="stat-item">
            <span>Time:</span>
            <span id="timer">00:00</span>
        </div>
        <div class="stat-item">
            <span>Level:</span>
            <span id="level">1</span>
        </div>
    </div>

    <!-- Order Display -->
    <div class="order-display">
        <div class="order-title">TARGET ORDER</div>
        <div class="order-stack" id="target-order"></div>
    </div>

    <!-- Conveyor Stations -->
    <div class="conveyor-stations">
        <div class="work-station" id="station-0">
            <div class="dessert-stack" id="stack-0"></div>
        </div>
        <div class="work-station" id="station-1">
            <div class="dessert-stack" id="stack-1"></div>
        </div>
        <div class="work-station active" id="station-2">
            <div class="dessert-stack" id="stack-2"></div>
        </div>
        <div class="work-station" id="station-3">
            <div class="dessert-stack" id="stack-3"></div>
        </div>
        <div class="work-station" id="station-4">
            <div class="dessert-stack" id="stack-4"></div>
        </div>
    </div>

    <!-- Conveyor Controls - REMOVED -->
    <!-- <div class="conveyor-controls">
        <button class="move-btn" id="move-left" onclick="moveConveyor('left')">←</button>
        <button class="move-btn" id="move-right" onclick="moveConveyor('right')">→</button>
    </div> -->

    <!-- Ingredient Selection Grid -->
    <div class="ingredient-grid" id="ingredient-grid">
        <!-- Row 1 -->
        <div class="ingredient-btn" data-type="container" data-id="1">
            <img src="./assets/cone.png" alt="Cone">
        </div>
        <div class="ingredient-btn" data-type="scoop1" data-id="1">
            <img src="./assets/vanilla.png" alt="Vanilla">
        </div>
        <div class="ingredient-btn" data-type="scoop2" data-id="1">
            <img src="./assets/black-currant.png" alt="Black-currant">
        </div>
        <div class="ingredient-btn" data-type="topping" data-id="1">
            <img src="./assets/sprinkles.png" alt="Sprinkles">
        </div>
        
        <!-- Row 2 -->
        <div class="ingredient-btn" data-type="container" data-id="2">
            <img src="./assets/cup.png" alt="Cup">
        </div>
        <div class="ingredient-btn" data-type="scoop1" data-id="2">
            <img src="./assets/chocolate.png"  alt="Chocolate">
        </div>
        <div class="ingredient-btn" data-type="scoop2" data-id="2">
            <img src="./assets/mango.png" alt="Mango">
        </div>
        <div class="ingredient-btn" data-type="topping" data-id="2">
            <img src="./assets/chocochips.png" alt="Choco Chips">
        </div>
        
        <!-- Row 3 -->
        <div class="ingredient-btn" data-type="container" data-id="3">
            <img src="./assets/glass.png" alt="Glass">
        </div>
        <div class="ingredient-btn" data-type="scoop1" data-id="3">
            <img src="./assets/orange.png" alt="Orange">
        </div>
        <div class="ingredient-btn" data-type="scoop2" data-id="3">
            <img src="./assets/mint.png" alt="Mint">
        </div>
        <div class="ingredient-btn" data-type="topping" data-id="3">
            <img src="./assets/cherry.png" alt="Cherry">
        </div>
    </div>

    <!-- Control Buttons -->
    <div class="control-buttons">
        <button class="control-btn" onclick="clearDessert()">Clear</button>
        <button class="control-btn" onclick="serveDessert()">Serve</button>
        <button class="control-btn" onclick="skipOrder()">Skip</button>
        <button class="control-btn" onclick="newGame()">New Game</button>
    </div>

    <!-- Feedback Messages -->
    <div class="feedback" id="feedback"></div>

    <!-- Game Over Modal -->
    <div class="game-over" id="game-over">
        <h2>Game Over!</h2>
        <p>Final Score: <span id="final-score">0</span></p>
        <p>Orders Completed: <span id="final-orders">0</span></p>
        <p>Time Played: <span id="final-time">00:00</span></p>
        <br>
        <button class="control-btn" onclick="newGame()">Play Again</button>
        <button class="control-btn" onclick="window.location.href='index.html'">Home</button>
    </div>

    <script>
        // Game Data
        const containers = [
            { id: 1, image: './assets/cone.png', type: 'cone' },
            { id: 2, image: './assets/cup.png', type: 'cup' },
            { id: 3, image: './assets/glass.png', type: 'glass' }
        ];

        const scoop1 = [
            { id: 1, image: './assets/vanilla.png', type: 'vanilla' },
            { id: 2, image: './assets/chocolate.png', type: 'chocolate' },
            { id: 3, image: './assets/orange.png', type: 'orange' }
        ];

        const scoop2 = [
            { id: 1, image: './assets/black-currant.png', type: 'black currant' },
            { id: 2, image: './assets/mango.png', type: 'mango' },
            { id: 3, image: './assets/mint.png', type: 'mint' }
        ];

        const toppings = [
            { id: 1, image: './assets/sprinkles.png', type: 'sprinkles' },
            { id: 2, image: './assets/chocochips.png', type: 'choco chips' },
            { id: 3, image: './assets/cherry.png', type: 'cherry' }
        ];

        // Sample Orders
        const orders = [
            { container: 1, scoop1: 1, scoop2: 1, topping: 1 },
            { container: 2, scoop1: 2, scoop2: 2, topping: 2 },
            { container: 3, scoop1: 3, scoop2: 3, topping: 3 },
            { container: 1, scoop1: 1, scoop2: 2, topping: 1 },
            { container: 2, scoop1: 3, scoop2: 1, topping: 2 },
            { container: 3, scoop1: 2, scoop2: 3, topping: 3 },
            { container: 1, scoop1: 2, scoop2: 1, topping: 3 },
            { container: 2, scoop1: 1, scoop2: 3, topping: 1 },
        ];

        // Game State
        let currentOrder = {};
        let score = 0;
        let ordersCompleted = 0;
        let level = 1;
        let gameTime = 0;
        let gameInterval;
        let orderIndex = 0;
        let currentStation = 2;
        let conveyorStations = [{}, {}, {}, {}, {}];

        function initGame() {
            score = 0;
            ordersCompleted = 0;
            level = 1;
            gameTime = 0;
            orderIndex = 0;
            currentStation = 2;
            conveyorStations = [{}, {}, {}, {}, {}];
            
            updateDisplay();
            generateNewOrder();
            startTimer();
            updateConveyorDisplay();
            
            document.querySelectorAll('.ingredient-btn').forEach(btn => {
                btn.addEventListener('click', selectIngredient);
            });
        }

        function startTimer() {
            clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                gameTime++;
                updateDisplay();
            }, 1000);
        }

        function generateNewOrder() {
            if (orderIndex >= orders.length) {
                orderIndex = 0;
                level++;
                shuffleArray(orders);
            }
            
            currentOrder = { ...orders[orderIndex] };
            orderIndex++;
            displayOrder();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function displayOrder() {
            const orderDisplay = document.getElementById('target-order');
            orderDisplay.innerHTML = '';
            
            // Create stacked order display (TOP TO BOTTOM: topping, scoop2, scoop1, container)
            const layers = [];
            
            // Topping (top)
            const toppingDiv = document.createElement('div');
            toppingDiv.className = 'order-item topping-layer'; /* Added topping-layer class */
            const toppingItem = toppings.find(t => t.id === currentOrder.topping);
            toppingDiv.style.backgroundImage = `url('${toppingItem.image}')`;
            if (toppingItem.filter) toppingDiv.style.filter = toppingItem.filter;
            layers.push(toppingDiv);
            
            // Scoop2
            const scoop2Div = document.createElement('div'); /* Corrected variable name */
            scoop2Div.className = 'order-item';
            const scoop2Item = scoop2.find(s => s.id === currentOrder.scoop2);
            scoop2Div.style.backgroundImage = `url('${scoop2Item.image}')`;
            if (scoop2Item.filter) scoop2Div.style.filter = scoop2Item.filter;
            layers.push(scoop2Div);
            
            // Scoop1
            const scoop1Div = document.createElement('div'); /* Corrected variable name */
            scoop1Div.className = 'order-item';
            const scoop1Item = scoop1.find(s => s.id === currentOrder.scoop1);
            scoop1Div.style.backgroundImage = `url('${scoop1Item.image}')`;
            if (scoop1Item.filter) scoop1Div.style.filter = scoop1Item.filter;
            layers.push(scoop1Div);
            
            // Container (bottom)
            const containerDiv = document.createElement('div');
            containerDiv.className = 'order-item';
            containerDiv.style.backgroundImage = `url('${containers.find(c => c.id === currentOrder.container).image}')`;
            layers.push(containerDiv);
            
            // Add layers to display
            layers.forEach(layer => orderDisplay.appendChild(layer));
        }

        function selectIngredient(event) {
            const btn = event.currentTarget;
            const type = btn.dataset.type;
            const id = parseInt(btn.dataset.id);
            
            // Clear previous selection of same type
            document.querySelectorAll(`[data-type="${type}"]`).forEach(b => {
                b.classList.remove('selected');
            });
            
            // Select current button
            btn.classList.add('selected');
            
            // Add ingredient to current station
            if (!conveyorStations[currentStation]) {
                conveyorStations[currentStation] = {};
            }
            conveyorStations[currentStation][type] = id;
            
            updateConveyorDisplay();
        }

        // Removed moveConveyor function as per user request
        // function moveConveyor(direction) {
        //     if (direction === 'left' && currentStation > 0) {
        //         currentStation--;
        //     } else if (direction === 'right' && currentStation < 4) {
        //         currentStation++;
        //     }
            
        //     updateConveyorDisplay();
        //     updateMoveButtons();
        // }

        // Removed updateMoveButtons function as per user request
        // function updateMoveButtons() {
        //     document.getElementById('move-left').disabled = currentStation === 0;
        //     document.getElementById('move-right').disabled = currentStation === 4;
        // }

        function updateConveyorDisplay() {
            // Update active station highlight
            document.querySelectorAll('.work-station').forEach((station, index) => {
                if (index === currentStation) {
                    station.classList.add('active');
                } else {
                    station.classList.remove('active');
                }
            });
            
            // Update all station displays with proper stacking (topping on top, container at bottom)
            conveyorStations.forEach((station, index) => {
                const stackElement = document.getElementById(`stack-${index}`);
                stackElement.innerHTML = '';
                
                if (station && Object.keys(station).length > 0) {
                    // Create layers in reverse stacking order for proper visual stacking
                    // Display order: topping, scoop2, scoop1, container (top to bottom)
                    const layerOrder = ['topping', 'scoop2', 'scoop1', 'container'];
            
                    layerOrder.forEach(layerType => {
                        if (station[layerType]) {
                            const layerDiv = document.createElement('div');
                            layerDiv.className = 'dessert-layer';
                            if (layerType === 'topping') { /* Added topping-layer class */
                                layerDiv.classList.add('topping-layer');
                            }
                            
                            let itemData;
                            switch(layerType) {
                                case 'container':
                                    itemData = containers.find(c => c.id === station[layerType]);
                                    break;
                                case 'scoop1':
                                    itemData = scoop1.find(s => s.id === station[layerType]);
                                    break;
                                case 'scoop2':
                                    itemData = scoop2.find(s => s.id === station[layerType]);
                                    break;
                                case 'topping':
                                    itemData = toppings.find(t => t.id === station[layerType]);
                                    break;
                            }
                            
                            if (itemData) {
                                layerDiv.style.backgroundImage = `url('${itemData.image}')`;
                                if (itemData.filter) layerDiv.style.filter = itemData.filter;
                                stackElement.appendChild(layerDiv);
                            }
                        }
                    });
                }
            });
            
            // Removed call to updateMoveButtons as per user request
            // updateMoveButtons();
        }

        function serveDessert() {
            const currentDessert = conveyorStations[currentStation];
            
            if (!currentDessert || !currentDessert.container || !currentDessert.scoop1 || !currentDessert.scoop2 || !currentDessert.topping) {
                showFeedback('Complete the dessert first!', 'error');
                return;
            }
            
            const isMatch = 
                currentDessert.container === currentOrder.container &&
                currentDessert.scoop1 === currentOrder.scoop1 &&
                currentDessert.scoop2 === currentOrder.scoop2 &&
                currentDessert.topping === currentOrder.topping;
            
            if (isMatch) {
                score += 10 + (level * 5);
                ordersCompleted++;
                showFeedback('Perfect! Order delivered!', 'success');
                
                if (ordersCompleted % 5 === 0) {
                    level++;
                    showFeedback(`Level Up! Now Level ${level}`, 'success');
                }
            } else {
                score = Math.max(0, score - 5);
                showFeedback('Wrong order! Try again.', 'error');
            }
            
            clearDessert();
            generateNewOrder();
            updateDisplay();
            
            if (ordersCompleted >= 20) {
                endGame();
            }
        }

        function clearDessert() {
            conveyorStations[currentStation] = {};
            document.querySelectorAll('.ingredient-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            updateConveyorDisplay();
        }

        function skipOrder() {
            score = Math.max(0, score - 3);
            generateNewOrder();
            clearDessert();
            updateDisplay();
            showFeedback('Order skipped!', 'error');
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type}`;
            feedback.style.display = 'block';
            
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 2000);
        }

        function updateDisplay() {
            document.getElementById('score').textContent = score;
            document.getElementById('orders-completed').textContent = ordersCompleted;
            document.getElementById('level').textContent = level;
            document.getElementById('timer').textContent = formatTime(gameTime);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function endGame() {
            clearInterval(gameInterval);
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-orders').textContent = ordersCompleted;
            document.getElementById('final-time').textContent = formatTime(gameTime);
            document.getElementById('game-over').style.display = 'block';
        }

        function newGame() {
            document.getElementById('game-over').style.display = 'none';
            clearInterval(gameInterval);
            initGame();
        }

        // Initialize game when page loads
        window.addEventListener('load', initGame);

        // Handle page visibility
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(gameInterval);
            } else {
                startTimer();
            }
        });
    </script>
</body>
</html>
